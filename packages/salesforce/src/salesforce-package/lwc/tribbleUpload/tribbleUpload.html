<template>
    <lightning-card title="Upload to Tribble" icon-name="standard:file">
        <!-- Card actions -->
        <div slot="actions">
            <lightning-button-group>
                <lightning-button
                    label="Clear"
                    onclick={handleClear}
                    icon-name="utility:clear"
                    disabled={isUploading}
                ></lightning-button>
            </lightning-button-group>
        </div>

        <div class="slds-card__body slds-card__body_inner">
            <div class="upload-container">
                <!-- File input -->
                <div class="file-input-section">
                    <lightning-input
                        type="file"
                        label="Select Files"
                        accept={acceptedFormats}
                        multiple={allowMultiple}
                        onchange={handleFileChange}
                        disabled={isUploading}
                    ></lightning-input>

                    <div class="slds-text-body_small slds-text-color_weak slds-m-top_x-small">
                        <p>{acceptedFormatsLabel}</p>
                        <p>{maxFileSizeLabel}</p>
                    </div>
                </div>

                <!-- Metadata form -->
                <div class="metadata-section slds-m-top_medium">
                    <div class="slds-text-heading_small slds-m-bottom_small">
                        Document Metadata (Optional)
                    </div>

                    <lightning-layout multiple-rows>
                        <lightning-layout-item size="12" medium-device-size="6" padding="around-small">
                            <lightning-input
                                label="Title"
                                value={metadata.title}
                                data-field="title"
                                onchange={handleMetadataChange}
                                placeholder="Document title"
                            ></lightning-input>
                        </lightning-layout-item>

                        <lightning-layout-item size="12" medium-device-size="6" padding="around-small">
                            <lightning-input
                                label="Author"
                                value={metadata.author}
                                data-field="author"
                                onchange={handleMetadataChange}
                                placeholder="Author name"
                            ></lightning-input>
                        </lightning-layout-item>

                        <lightning-layout-item size="12" medium-device-size="6" padding="around-small">
                            <lightning-input
                                label="Source"
                                value={metadata.source}
                                data-field="source"
                                onchange={handleMetadataChange}
                                placeholder="Document source"
                            ></lightning-input>
                        </lightning-layout-item>

                        <lightning-layout-item size="12" medium-device-size="6" padding="around-small">
                            <lightning-input
                                label="Category"
                                value={metadata.category}
                                data-field="category"
                                onchange={handleMetadataChange}
                                placeholder="Document category"
                            ></lightning-input>
                        </lightning-layout-item>

                        <lightning-layout-item size="12" padding="around-small">
                            <lightning-input
                                label="Tags"
                                value={metadata.tags}
                                data-field="tags"
                                onchange={handleMetadataChange}
                                placeholder="Comma-separated tags"
                            ></lightning-input>
                        </lightning-layout-item>
                    </lightning-layout>
                </div>

                <!-- Selected files list -->
                <template if:true={hasSelectedFiles}>
                    <div class="selected-files-section slds-m-top_medium">
                        <div class="slds-text-heading_small slds-m-bottom_small">
                            Selected Files
                        </div>

                        <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                            <thead>
                                <tr class="slds-line-height_reset">
                                    <th scope="col">
                                        <div class="slds-truncate" title="File Name">File Name</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate" title="Size">Size</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate" title="Status">Status</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <template for:each={selectedFiles} for:item="file">
                                    <tr key={file.id} class="slds-hint-parent">
                                        <td data-label="File Name">
                                            <div class="slds-truncate" title={file.name}>
                                                {file.name}
                                            </div>
                                        </td>
                                        <td data-label="Size">
                                            <div class="slds-truncate">
                                                {file.size}
                                            </div>
                                        </td>
                                        <td data-label="Status">
                                            <template if:true={file.status === 'pending'}>
                                                <lightning-badge label="Pending" class="slds-badge_lightest"></lightning-badge>
                                            </template>
                                            <template if:true={file.status === 'uploading'}>
                                                <lightning-badge label="Uploading..." class="slds-theme_info"></lightning-badge>
                                            </template>
                                            <template if:true={file.status === 'completed'}>
                                                <lightning-badge label="Completed" class="slds-theme_success"></lightning-badge>
                                            </template>
                                            <template if:true={file.status === 'failed'}>
                                                <lightning-badge label="Failed" class="slds-theme_error"></lightning-badge>
                                            </template>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>

                        <!-- Upload button -->
                        <div class="slds-m-top_medium">
                            <lightning-button
                                label={uploadButtonLabel}
                                variant="brand"
                                onclick={handleUpload}
                                disabled={uploadButtonDisabled}
                                icon-name="utility:upload"
                                icon-position="left"
                            ></lightning-button>
                        </div>

                        <!-- Upload progress -->
                        <template if:true={isUploading}>
                            <div class="slds-m-top_medium">
                                <lightning-progress-bar
                                    value={uploadProgress}
                                    size="large"
                                ></lightning-progress-bar>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- Uploaded files history -->
                <template if:true={hasUploadedFiles}>
                    <div class="uploaded-files-section slds-m-top_large">
                        <div class="slds-text-heading_small slds-m-bottom_small">
                            Upload History
                            <lightning-button
                                label="Clear History"
                                onclick={handleClearUploaded}
                                variant="base"
                                class="slds-float_right"
                            ></lightning-button>
                        </div>

                        <div class="slds-box slds-theme_shade">
                            <template for:each={uploadedFiles} for:item="file">
                                <div key={file.name} class="upload-history-item">
                                    <lightning-icon
                                        icon-name="utility:check"
                                        size="x-small"
                                        variant="success"
                                    ></lightning-icon>
                                    <span class="file-name">{file.name}</span>
                                    <span class="document-ids">
                                        Document IDs: {file.documentIds}
                                    </span>
                                    <lightning-formatted-date-time
                                        value={file.timestamp}
                                        hour="2-digit"
                                        minute="2-digit"
                                    ></lightning-formatted-date-time>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Loading spinner -->
        <template if:true={isUploading}>
            <lightning-spinner
                alternative-text="Uploading"
                size="small"
            ></lightning-spinner>
        </template>
    </lightning-card>
</template>
